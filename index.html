<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIDILLI MIDI Web Tool - Analyzer, Monitor & Sender</title>
    <meta name="description" content="MIDILLI MIDI Web Tool is a web-based tool to view and analyze incoming MIDI messages and send MIDI messages in real time.">
    <meta name="robots" content="index, follow">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 2em; background: #222222; color: #F3F6F9; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #374151; padding: 6px 12px; text-align: center; vertical-align: middle; }
        th { background: #2D3748; color: #FFF; }
        td { background: #23272F; color: #F3F6F9; }
        #inputs { margin-top: 2em; margin-bottom: 1em; display: flex; align-items: center; gap: 1.2em; }
        h1 { text-align: center; color: #fff; }
        select, button, input[type="checkbox"] {
            background: #374151;
            color: #F3F6F9;
            border: 1px solid #4B5563;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        select:focus, button:focus {
            outline: 2px solid #FFF;
        }
        button:hover, select:hover {
            background: #4B5563;
            color: #FFF;
        }
        #aboutBtn, #aboutOkBtn, #clearBtn, #connectBtn, #disconnectBtn, #refreshBtn, #toggleRawFormat {
            background: #2D3748;
            color: #FFF;
            border: 1px solid #FFF;
        }
        #aboutBtn:hover, #aboutOkBtn:hover, #clearBtn:hover, #connectBtn:hover, #disconnectBtn:hover, #refreshBtn:hover, #toggleRawFormat:hover {
            background: #FFF;
            color: #222222;
        }
        a { color: #FFF; }
    </style>
</head>
<body>
<noscript>
    <div style="background: #ffeb3b; color: #222; padding: 1.5em; margin: 2em auto; border-radius: 8px; max-width: 700px; font-size: 1.15em; text-align: center; font-weight: bold;">
        This site allows you to view and analyze MIDI messages from your connected MIDI devices and send MIDI messages in real time.<br>
        JavaScript is needed to access your MIDI devices and display incoming MIDI data and send.<br><br>
        Please enable JavaScript in your browser settings and reload the page.
    </div>
</noscript>
    <a href="https://midilli.tech" target="_blank" style="position: absolute; left: 2em; top: 1em; font-size: 1.2em; color: #fff; text-decoration: none; font-weight: bold; z-index: 10; display: flex; flex-direction: column; align-items: center;">
        <img src="https://midilli.tech/wp-content/uploads/2024/10/cropped-MidilliLogoUnisexNoBg.png" alt="MIDILLI Logo" style="width:40px; height:auto; margin-bottom:2px;">
        MIDILLI Tech
    </a>
    <div style="margin-top: 70px;">
        <h1>MIDILLI MIDI Monitor</h1>
    </div>
    <p style="text-align:center; margin: 1em 0; color: #ccc; font-size:1.1em;">
        Select the MIDI input(s) you want to monitor from the list and press Connect.<br>
        Use the Ctrl/Cmd key to select or deselect multiple inputs.
        You can also send MIDI messages to the selected output device.<br>
    </p>
    <div id="inputs">
        <label for="inputSelect">MIDI Input:</label>
        <select id="inputSelect" multiple size="4"></select>
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" style="display:none;">Disconnect</button>
        <button id="refreshBtn">Refresh Devices</button>
        <label style="margin-left:1em;">
            <input type="checkbox" id="autoScroll" checked>
            Auto Scroll
        </label>
        <button id="clearBtn">Clear</button>
        <label for="outputSelect" style="margin-left:1em;">MIDI Output:</label>
        <select id="outputSelect">
        </select>
        <button id="sendBtn">Send</button>
        <div style="flex:1"></div>
        <button id="aboutBtn">Help/About</button>
    </div>
    <div id="aboutModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#222; color:#fff; padding:2em 2em 1.5em 2em; border-radius:8px; max-width:90vw; max-height:90vh; box-shadow:0 4px 32px #000;">
            <h2 style="margin-top:0;">About</h2>
            <p>
                This MIDI tool allows you to both monitor all incoming MIDI messages from your selected devices and send custom MIDI messages to any connected output device, including Note, Control Change (CC), Clock, Program Change (PC), SysEx (System Exclusive), and more.<br><br>
                Supported browsers include Google Chrome, Edge, and Firefox (experimental). If you do not see your MIDI device, please ensure permission is granted, the device is connected and not in use by another application, then refresh the page.<br>
                After connecting a new device, use the Refresh Devices button to update the device list.<br><br>
                To monitor, select one or more MIDI input devices (hold Ctrl/Cmd to select multiple) and press Connect. To send messages, select a MIDI output device and use the Send button.<br>
                You can disconnect inputs at any time by clicking Disconnect.<br>
                Enable Auto Scroll to keep the latest messages in view.<br><br>
                The button in the Raw Message column lets you toggle between hexadecimal and decimal display for message data.
            </p>
            <p style="margin-top:2em; font-size:0.95em; color:#aaa;">&copy; 2024 - <span id="aboutYear"></span> <a href="https://midilli.tech" target="_blank" style="color:#aaa; text-decoration:underline;">MIDILLI Tech</a>. All rights reserved.<br>MIDILLI MIDI Web Tool Version: <span id="aboutLastUpdated"></span></p>
            <button id="aboutOkBtn" style="margin-top:1.5em; background:#444; color:#fff; border:none; padding:8px 22px; border-radius:4px; font-size:1em; cursor:pointer;">OK</button>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Type</th>
                <th>Value</th>
                <th>Channel</th>
                <th>Device</th>
                <th>
                    Raw Message
                    <button id="toggleRawFormat" style="margin-left:8px;background:#222; color:#fff; border:none; border-radius:4px; font-size:1em; cursor:pointer;" title="Click to toggle between hex and dec">Hex</button>
                </th>
            </tr>
        </thead>
        <tbody id="logBody"></tbody>
    </table>

    <script src="midi.js"></script>
    <script>
        LAST_UPDATED = "05.08.2025"; // Update this with the actual last updated date
        // Show error if MIDI access is denied
        if (!navigator.requestMIDIAccess) {
            alert("Web MIDI API is not supported in this browser. Please use Chrome, Edge, or Firefox (with experimental features enabled).");
        }

        // MIDI message type parser
        function parseMidiMessage(data) {
            const status = data[0];
            if (status >= 0x80 && status <= 0xEF) {
                const typeNibble = status & 0xF0;
                const channel = (status & 0x0F) + 1;
                switch (typeNibble) {
                    case 0x80: // Note Off
                    case 0x90: { // Note On
                        const noteNumber = data[1];
                        const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
                        const octave = Math.floor(noteNumber / 12) - 1;
                        const noteName = noteNames[noteNumber % 12] + octave;
                        return { 
                            type: (typeNibble === 0x90 ? "Note On" : "Note Off") + ` (${noteName})`, 
                            channel, 
                            value: data[2] // velocity
                        };
                    }
                    case 0xA0: // Poly AT
                        return { type: "Poly AT", channel, value: data[2] };
                    case 0xB0: // CC
                        return { type: `CC (#${data[1]})`, channel, value: data[2] };
                    case 0xC0: // Program
                        return { type: "Program", channel, value: data[1] };
                    case 0xD0: // Channel AT
                        return { type: "Channel AT", channel, value: data[1] };
                    case 0xE0: // Pitch Bend
                        return { type: "Pitch Bend", channel, value: ((data[2] << 7) | data[1]) - 8192 };
                }
            } else if (status === 0xF0) {
                return { type: "SysEx", channel: "n/a", value: "" };
            } else if (status === 0xF8) {
                return { type: "Clock", channel: "n/a", value: "" };
            } else if (status === 0xFA) {
                return { type: "Start", channel: "n/a", value: "" };
            } else if (status === 0xFB) {
                return { type: "Continue", channel: "n/a", value: "" };
            } else if (status === 0xFC) {
                return { type: "Stop", channel: "n/a", value: "" };
            } else if (status === 0xFE) {
                return { type: "Active Sense", channel: "n/a", value: "" };
            } else if (status === 0xFF) {
                return { type: "Reset", channel: "n/a", value: "" };
            }
            return { type: "Unknown", channel: "n/a", value: "" };
        }

        // Fill input select
        async function populateInputs() {
            await MIDIEngine.init();
            const inputNames = JSON.parse(MIDIEngine.get_input_port_names());
            const select = document.getElementById('inputSelect');
            select.innerHTML = "";
            inputNames.forEach((name, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = name;
                select.appendChild(opt);
            });
            // Populate output select
            const outputNames = JSON.parse(MIDIEngine.get_output_port_names());
            const outputSelect = document.getElementById('outputSelect');
            outputSelect.innerHTML = "";
            const sendBtn = document.getElementById('sendBtn');
            if (outputNames.length === 0) {
                const opt = document.createElement('option');
                opt.value = "";
                opt.textContent = "None";
                opt.disabled = true;
                opt.selected = true;
                outputSelect.appendChild(opt);
                outputSelect.disabled = true;
                sendBtn.disabled = true;
            } else {
                outputNames.forEach((name, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.textContent = name;
                    outputSelect.appendChild(opt);
                });
                outputSelect.disabled = false;
                sendBtn.disabled = false;
            }
            // Show notification if no devices found
            if (inputNames.length === 0) {
                // Remove any previous notification
                let notif = document.getElementById('noMidiNotif');
                if (!notif) {
                    notif = document.createElement('div');
                    notif.id = 'noMidiNotif';
                    notif.style.background = '#ffeb3b';
                    notif.style.color = '#222';
                    notif.style.padding = '1em';
                    notif.style.margin = '1em 0';
                    notif.style.borderRadius = '6px';
                    notif.style.fontWeight = 'bold';
                    notif.style.textAlign = 'center';
                    notif.style.maxWidth = '700px';
                    notif.style.marginLeft = 'auto';
                    notif.style.marginRight = 'auto';
                    notif.innerHTML = `
                        No MIDI input devices found.<br>
                        This may be because permission was not granted, the device is in use by another application, or not connected.<br>
                        Please try again after resolving the issue.<br>
                        If permission was not granted, click the icon next to the address bar and allow MIDI device access.<br>
                    `;
                    select.parentNode.parentNode.insertBefore(notif, select.parentNode.nextSibling);
                }
                // document.getElementById('connectBtn').disabled = true;
            } else {
                // Remove notification if devices are found
                const notif = document.getElementById('noMidiNotif');
                if (notif) notif.remove();
                // Enable/disable connectBtn based on selection
                // const connectBtn = document.getElementById('connectBtn');
                // connectBtn.disabled = select.selectedOptions.length === 0;
                // Add event listener to enable/disable connectBtn on selection change
                select.onchange = function() {
                    // connectBtn.disabled = select.selectedOptions.length === 0;
                };
            }
        }
        // Log MIDI message
        function logMidiMessage({timestamp, type, value, channel, device, raw}) {
            const tbody = document.getElementById('logBody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${timestamp}</td>
                <td>${type}</td>
                <td>${value !== undefined ? value : ""}</td>
                <td>${channel}</td>
                <td>${device}</td>
                <td>${raw}</td>
            `;
            tbody.appendChild(tr);
            // Scroll to bottom if autoScroll is enabled
            if (document.getElementById('autoScroll').checked) {
                tr.scrollIntoView({ behavior: "smooth" });
            }
        }
        // MIDI callback
        window._midi_callback = function(json) {
            const msg = JSON.parse(json);
            const data = msg.data || msg; // support both formats
            const index = msg.index !== undefined ? msg.index : null;
            const now = new Date();
            const timestamp = now.toLocaleTimeString('en-GB', { hour12: false }) + '.' + now.getMilliseconds().toString().padStart(3, '0');
            const { type, channel, value } = parseMidiMessage(data);
            // Get device name using index if available
            let device = "n/a";
            const select = document.getElementById('inputSelect');
            if (index !== null && select.options[index]) {
                device = select.options[index].textContent;
            } else {
                device = select.selectedOptions[0]?.textContent || "n/a";
            }
            // Format raw message as hex and dec
            const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            const dec = Array.from(data).join(' ');
            logMidiMessage({
                timestamp,
                type,
                value,
                channel,
                device,
                raw: `<span class="raw-msg" data-hex="${hex}" data-dec="${dec}">${rawFormat === 'hex' ? hex : dec}</span>`
            });

        };

        // Connect button
        document.getElementById('connectBtn').onclick = function() {
            const select = document.getElementById('inputSelect');
            const selectedIndices = Array.from(select.selectedOptions).map(opt => Number(opt.value));
            if (selectedIndices.length === 0) {
                showNotification("Please select at least one MIDI input device.", 2000);
                return;
            }
            MIDIEngine.close_input_port();
            selectedIndices.forEach(idx => MIDIEngine.open_input_port(idx));
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('disconnectBtn').style.display = '';
            document.getElementById('inputSelect').disabled = true;
            showNotification("Listening MIDI devices...", 0);
        };

        document.getElementById('sendBtn').onclick = function () {
            const outputSelect = document.getElementById('outputSelect');
            const selectedIndex = outputSelect.selectedIndex;
            if (selectedIndex < 0) {
                showNotification("Please select a MIDI output device.", 2000);
                return;
            }

            MIDIEngine.open_output_port(selectedIndex);

            const message = prompt("Enter MIDI message to send:\n- Decimal: e.g., '144 60 127'\n- Hex: prefix each byte with 0x, e.g., '0x90 0x3C 0x7F'");
            if (!message) return; // Cancelled

            const data = message
                .trim()
                .split(/\s+/)
                .map(val => {
                    if (/^0x[0-9a-fA-F]+$/.test(val)) {
                        return parseInt(val, 16);
                    } else if (/^[0-9]+$/.test(val)) {
                        return parseInt(val, 10);
                    } else {
                        return NaN;
                    }
                })
                .filter(num => !isNaN(num) && num >= 0 && num <= 255);

            if (data.length === 0) {
                showNotification("Invalid MIDI message format. Use decimal (e.g., '144 60 127') or hex with 0x prefix (e.g., '0x90 0x3C 0x7F').", 5000);
                return;
            }

            const midiMessage = new Uint8Array(data);
            MIDIEngine.send_message(midiMessage);
            showNotification(`Sent: ${message}`, 2000);

            // Parse type, value, channel from the message
            const { type, value, channel } = parseMidiMessage(data);
            // Get device name
            const device = outputSelect.options[selectedIndex]?.textContent || "n/a";
            // Format raw message as hex and dec
            const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
            const dec = Array.from(data).join(' ');

            logMidiMessage({
                timestamp: new Date().toLocaleTimeString('en-GB', { hour12: false }) + '.' + new Date().getMilliseconds().toString().padStart(3, '0'),
                type: type + " (Sent)",
                value,
                channel,
                device,
                raw: `<span class="raw-msg" data-hex="${hex}" data-dec="${dec}">${rawFormat === 'hex' ? hex : dec}</span>`
            });
        };

        // Disconnect button
        document.getElementById('disconnectBtn').onclick = function() {
            MIDIEngine.close_input_port();
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('connectBtn').style.display = '';
            document.getElementById('inputSelect').disabled = false;
            showNotification("Stopped listening.", 1500);
        };

        // Refresh button
        document.getElementById('refreshBtn').onclick = function() {
            MIDIEngine.refresh_devices();
            populateInputs();
            showNotification('Refreshed devices!');
        };

        // Show customizable notification
        function showNotification(text, duration = 1500) {
            let notif = document.getElementById('refreshNotif');
            if (!notif) {
                notif = document.createElement('div');
                notif.id = 'refreshNotif';
                notif.style.background = '#4caf50';
                notif.style.color = '#fff';
                notif.style.padding = '0.7em 1.2em';
                notif.style.marginTop = '0.7em';
                notif.style.borderRadius = '6px';
                notif.style.fontWeight = 'bold';
                notif.style.textAlign = 'center';
                notif.style.maxWidth = '220px';
                notif.style.marginLeft = '0';
                notif.style.marginRight = '0';
                // Insert below the send button
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.parentNode.insertBefore(notif, sendBtn.nextSibling);
            }
            notif.textContent = text;
            notif.style.display = '';
            if(duration > 0) {
                setTimeout(() => {
                    notif.style.display = 'none';
                }, duration);
            }
        }
        // Toggle raw message format
        let rawFormat = 'hex';
        document.getElementById('toggleRawFormat').onclick = function() {
            rawFormat = (rawFormat === 'hex') ? 'dec' : 'hex';
            this.textContent = (rawFormat === 'hex') ? 'Hex' : 'Dec';
            document.querySelectorAll('.raw-msg').forEach(td => {
                td.textContent = td.getAttribute(`data-${rawFormat}`);
            });
        };

        // On load
        populateInputs();

        // About modal logic
        document.getElementById('aboutBtn').onclick = function() {
            document.getElementById('aboutModal').style.display = 'flex';
            document.getElementById('aboutYear').textContent = new Date().getFullYear();
            document.getElementById('aboutLastUpdated').textContent = LAST_UPDATED; // Update this with the actual last updated date
        };
        document.getElementById('aboutOkBtn').onclick = function() {
            document.getElementById('aboutModal').style.display = 'none';
        };
        // Optional: close modal when clicking outside the modal box
        document.getElementById('aboutModal').onclick = function(e) {
            if (e.target === this) this.style.display = 'none';
        };

        // Clear button logic
        document.getElementById('clearBtn').onclick = function() {
            document.getElementById('logBody').innerHTML = '';
            showNotification('Cleared log!');
        };
    </script>
</body>
</html>